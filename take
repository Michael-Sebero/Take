#!/bin/sh

set -e

# Script version
SCRIPT_VERSION="1.0.0"
SCRIPT_NAME="take"

# Configuration
AUR_BASE_URL="https://aur.archlinux.org"
BUILD_DIR="${BUILD_DIR:-/tmp/aur-build-$$}"

# Colors for output
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    PURPLE='\033[0;35m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    NC='\033[0m' # No Color
else
    RED='' GREEN='' YELLOW='' BLUE='' PURPLE='' CYAN='' BOLD='' NC=''
fi

# Default options
CLEAN_BUILD=false
SKIP_DEPS=true
FORCE_INSTALL=false
SEARCH_MODE=false
INFO_MODE=false
QUIET=false
VERBOSE=false
FAST_MODE=true

# Usage information
show_usage() {
    cat << EOF
$SCRIPT_NAME $SCRIPT_VERSION - Enhanced AUR Helper

USAGE:
    $SCRIPT_NAME [OPTIONS] <packages...>
    $SCRIPT_NAME [OPTIONS] -S <packages...>    # Install packages
    $SCRIPT_NAME [OPTIONS] -Ss <query>         # Search packages
    $SCRIPT_NAME [OPTIONS] -Si <packages...>   # Show package info

OPTIONS:
    -S, --sync              Install packages (default)
    -Ss, --search           Search for packages
    -Si, --info             Show package information
    -c, --clean             Clean build directory before building
    -f, --force             Force installation (overwrite files)
    --fast                  Maximum speed mode (skip all checks)
    -q, --quiet             Reduce output
    -v, --verbose           Increase output
    -h, --help              Show this help message
    --version               Show version information

EXAMPLES:
    $SCRIPT_NAME wine-cachyos                  # Install wine-cachyos
    $SCRIPT_NAME -c wine-cachyos               # Clean build and install
    $SCRIPT_NAME -Ss wine                      # Search for wine packages
    $SCRIPT_NAME -Si wine-cachyos              # Show package info
EOF
}

# Logging functions
log_info() {
    if [ "$QUIET" != "true" ]; then
        printf "${BLUE}::${NC} %s\n" "$1"
    fi
}

log_success() {
    if [ "$QUIET" != "true" ]; then
        printf "${GREEN}::${NC} %s\n" "$1"
    fi
}

log_warning() {
    printf "${YELLOW}:: WARNING:${NC} %s\n" "$1" >&2
}

log_error() {
    printf "${RED}:: ERROR:${NC} %s\n" "$1" >&2
}

log_debug() {
    if [ "$VERBOSE" = "true" ]; then
        printf "${CYAN}:: DEBUG:${NC} %s\n" "$1" >&2
    fi
}

# Detect privilege escalation method
detect_privilege_escalation() {
    if command -v doas >/dev/null 2>&1; then
        echo "doas"
    elif command -v sudo >/dev/null 2>&1; then
        echo "sudo"
    else
        log_error "Neither sudo nor doas found. Please install one of them."
        exit 1
    fi
}

PRIV_ESC=$(detect_privilege_escalation)
log_debug "Using privilege escalation: $PRIV_ESC"

# Wrapper for privilege escalation
run_as_root() {
    if [ "$(id -u)" -eq 0 ]; then
        "$@"
    else
        case "$PRIV_ESC" in
            "doas")
                doas "$@"
                ;;
            "sudo")
                sudo "$@"
                ;;
        esac
    fi
}

# Find suitable build user
find_build_user() {
    local build_user
    if [ "$(id -u)" -eq 0 ]; then
        # Running as root, find a regular user
        build_user=$(getent passwd | awk -F: '$3 >= 1000 && $3 < 65534 && $7 !~ /nologin|false/ { print $1; exit }')
        if [ -n "$build_user" ]; then
            echo "$build_user"
        elif [ -n "$SUDO_USER" ]; then
            echo "$SUDO_USER"
        else
            echo "nobody"
        fi
    else
        echo "$USER"
    fi
}

BUILD_USER=$(find_build_user)
log_debug "Build user: $BUILD_USER"

# Search AUR packages
search_aur() {
    local query="$1"
    local url="https://aur.archlinux.org/rpc/?v=5&type=search&arg=$query"
    
    log_info "Searching AUR for: $query"
    local results=$(curl -s "$url")
    
    if ! echo "$results" | grep -q '"resultcount":[1-9]'; then
        log_warning "No packages found matching: $query"
        return 1
    fi
    
    if command -v jq >/dev/null 2>&1; then
        echo "$results" | jq -r '.results[] | "\(.Name) \(.Version)\n    \(.Description)"' 2>/dev/null || {
            log_error "Failed to parse search results. Is jq installed?"
            return 1
        }
    else
        echo "$results" | sed 's/.*"Name":"\([^"]*\)".*"Version":"\([^"]*\)".*"Description":"\([^"]*\)".*/\1 \2\n    \3/g'
    fi
}

# Show package info
show_package_info() {
    local package="$1"
    local url="https://aur.archlinux.org/rpc/?v=5&type=info&arg=$package"
    
    local info=$(curl -s "$url")
    
    if ! echo "$info" | grep -q '"resultcount":1'; then
        log_error "Package '$package' not found in AUR"
        return 1
    fi
    
    if command -v jq >/dev/null 2>&1; then
        echo "$info" | jq -r '
            .results[0] | 
            "Repository      : aur",
            "Name            : \(.Name)",
            "Version         : \(.Version)",
            "Description     : \(.Description // "None")",
            "URL             : \(.URL // "None")",
            "Maintainer      : \(.Maintainer // "Orphaned")",
            "Votes           : \(.NumVotes)",
            "Popularity      : \(.Popularity)"
        ' 2>/dev/null || {
            log_error "Failed to parse package info. Is jq installed?"
            return 1
        }
    else
        echo "$info" | sed -n 's/.*"Name":"\([^"]*\)".*/Name: \1/p'
        echo "$info" | sed -n 's/.*"Version":"\([^"]*\)".*/Version: \1/p'
        echo "$info" | sed -n 's/.*"Description":"\([^"]*\)".*/Description: \1/p'
    fi
}

# Build and install package (fast mode)
build_and_install_package() {
    local package="$1"
    local temp_dir="$BUILD_DIR/$package"
    
    log_info "Processing package: $package"
    
    # Setup build directory
    if [ "$CLEAN_BUILD" = "true" ] && [ -d "$temp_dir" ]; then
        rm -rf "$temp_dir"
    fi
    mkdir -p "$temp_dir"
    cd "$temp_dir"
    
    # Cleanup function
    cleanup_package() {
        if [ -d "$temp_dir" ]; then
            rm -rf "$temp_dir" 2>/dev/null || true
        fi
    }
    
    # Clone AUR repository
    log_info "Cloning AUR repository for $package..."
    local aur_url="$AUR_BASE_URL/${package}.git"
    
    if ! git clone --depth=1 "$aur_url" . 2>/dev/null; then
        log_error "Package '$package' not found in AUR"
        cleanup_package
        return 1
    fi
    
    # Set proper ownership if running as root (fast)
    if [ "$(id -u)" -eq 0 ] && [ "$BUILD_USER" != "root" ]; then
        chown -R "$BUILD_USER:$(id -gn "$BUILD_USER")" "$temp_dir" 2>/dev/null || true
    fi
    
    # Build package (minimal flags for speed)
    log_info "Building package $package..."
    
    # Use minimal makepkg args for maximum speed
    local makepkg_args="--noconfirm --skippgpcheck --skipinteg --nodeps --nocheck"
    
    local build_cmd
    if [ "$(id -u)" -eq 0 ] && [ "$BUILD_USER" != "root" ]; then
        if command -v runuser >/dev/null 2>&1; then
            build_cmd="runuser -u $BUILD_USER -- makepkg $makepkg_args"
        else
            build_cmd="makepkg $makepkg_args --asroot"
        fi
    else
        build_cmd="makepkg $makepkg_args"
    fi
    
    if ! eval "$build_cmd" 2>/dev/null; then
        log_error "Failed to build package $package"
        cleanup_package
        return 1
    fi
    
    # Find and install built package
    local package_file=$(find . -name "*.pkg.tar.*" -type f | head -1)
    
    if [ -z "$package_file" ]; then
        log_error "No package file found after building $package"
        cleanup_package
        return 1
    fi
    
    log_info "Installing package $package..."
    
    if ! run_as_root pacman -U --noconfirm "$package_file" 2>/dev/null; then
        log_error "Failed to install package $package"
        cleanup_package
        return 1
    fi
    
    log_success "Package $package installed successfully"
    cleanup_package
    return 0
}

# Parse command line arguments
parse_arguments() {
    while [ $# -gt 0 ]; do
        case "$1" in
            -S|--sync)
                # Default mode, nothing to change
                shift
                ;;
            -Ss|--search)
                SEARCH_MODE=true
                shift
                ;;
            -Si|--info)
                INFO_MODE=true
                shift
                ;;
            -c|--clean)
                CLEAN_BUILD=true
                shift
                ;;
            -f|--force)
                FORCE_INSTALL=true
                shift
                ;;
            --fast)
                FAST_MODE=true
                SKIP_DEPS=true
                shift
                ;;
            -q|--quiet)
                QUIET=true
                shift
                ;;
            -v|--verbose)
                VERBOSE=true
                shift
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            --version)
                echo "$SCRIPT_NAME $SCRIPT_VERSION"
                exit 0
                ;;
            --)
                shift
                break
                ;;
            -*)
                log_error "Unknown option: $1"
                show_usage
                exit 1
                ;;
            *)
                break
                ;;
        esac
    done
    
    # Remaining arguments are packages
    PACKAGES="$*"
}

# Main function
main() {
    # Create necessary directories
    mkdir -p "$BUILD_DIR"
    
    # Parse arguments
    parse_arguments "$@"
    
    # Handle different modes
    if [ "$SEARCH_MODE" = "true" ]; then
        for query in $PACKAGES; do
            search_aur "$query"
        done
        exit 0
    fi
    
    if [ "$INFO_MODE" = "true" ]; then
        for package in $PACKAGES; do
            show_package_info "$package"
            echo
        done
        exit 0
    fi
    
    # Install mode (default)
    if [ -z "$PACKAGES" ]; then
        log_error "No packages specified"
        show_usage
        exit 1
    fi
    
    local successful_packages=""
    local failed_packages=""
    local package_count=0
    
    # Count packages
    for package in $PACKAGES; do
        package_count=$((package_count + 1))
    done
    
    log_info "Installing $package_count AUR package(s)..."
    
    for package in $PACKAGES; do
        if build_and_install_package "$package"; then
            successful_packages="$successful_packages $package"
        else
            failed_packages="$failed_packages $package"
        fi
    done
    
    # Summary
    if [ -n "$successful_packages" ]; then
        log_success "Successfully installed:$successful_packages"
    fi
    
    if [ -n "$failed_packages" ]; then
        log_error "Failed to install:$failed_packages"
        exit 1
    fi
    
    log_success "All packages installed successfully!"
}

# Check dependencies (minimal)
check_dependencies() {
    if [ "$FAST_MODE" = "true" ]; then
        return 0
    fi
    
    local missing_deps=""
    
    # Only check critical commands
    if ! command -v git >/dev/null 2>&1; then
        missing_deps="$missing_deps git"
    fi
    
    if [ -n "$missing_deps" ]; then
        log_error "Missing required dependencies:$missing_deps"
        log_info "Please install them with: pacman -S$missing_deps"
        exit 1
    fi
}

# Initialize
if [ "${0##*/}" = "take" ]; then
    check_dependencies
    main "$@"
fi
